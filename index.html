<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ‰ãƒªãƒ«å­¦ç¿’</title>
  <style>
    :root {
      --neumorphic-light: #e0e5ec;
      --neumorphic-dark: #a7aab1;
      --neumorphic-bg: #ebf0f7;
      --main-color: #4CAF50; /* Green */
      --accent-color: #8BC34A; /* Light Green */
      --alt-color: #2196F3; /* Blue */
      --alt-accent: #64B5F6; /* Light Blue */
      --text-color: #333;
      --shadow-light: inset 5px 5px 10px rgba(0, 0, 0, 0.1), inset -5px -5px 10px rgba(255, 255, 255, 0.7);
      --shadow-dark: -5px -5px 10px rgba(255, 255, 255, 0.7), 5px 5px 10px rgba(0, 0, 0, 0.1);
      --inner-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.7);
      --border-radius: 20px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--neumorphic-bg);
      color: var(--text-color);
      padding: 0 20px; /* ä¸Šã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚0ã«è¨­å®š */
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      box-sizing: border-box;
      overflow-x: hidden;
    }

    h1 {
      margin-bottom: 5px; /* ä¸‹ã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚5pxã«æ¸›ã‚‰ã™ */
      font-size: 2.2em;
      color: var(--main-color);
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }

    /* å…¨ä½“ã®é€²æ—ãƒãƒ¼ */
    .overall-progress-container {
      width: 100%;
      max-width: 380px;
      margin-bottom: 5px; /* ä¸‹ã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚5pxã«æ¸›ã‚‰ã™ */
      padding: 15px;
      border-radius: var(--border-radius);
      background-color: var(--neumorphic-bg);
      box-shadow: var(--inner-shadow);
      text-align: left;
      font-size: 0.9em;
      color: #666;
    }

    .overall-progress-bar {
      width: 100%;
      height: 12px;
      background-color: var(--neumorphic-light);
      border-radius: 6px;
      margin-top: 8px;
      box-shadow: inset 1px 1px 3px rgba(0,0,0,0.1), inset -1px -1px 3px rgba(255,255,255,0.7);
    }

    .overall-progress-fill {
      height: 100%;
      width: 0%;
      background-color: var(--main-color);
      border-radius: 6px;
      transition: width 0.5s ease-out;
    }


    /* å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ãƒ†ãƒŠ */
    .container {
      width: 100%;
      max-width: 380px; /* ã‚¹ãƒãƒ›ã«é©ã—ãŸæœ€å¤§å¹… */
      padding: 15px 20px; /* ä¸Šã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚15pxã«è¨­å®š */
      border-radius: var(--border-radius);
      background-color: var(--neumorphic-bg);
      box-shadow: var(--shadow-dark);
      margin-bottom: 10px; /* ä¸‹ã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚10pxã«æ¸›ã‚‰ã™ */
      box-sizing: border-box;
    }

    .progress-box {
      margin-bottom: 10px; /* ä¸‹ã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚10pxã«æ¸›ã‚‰ã™ */
      font-size: 1.1em;
      font-weight: bold;
      color: var(--main-color);
      text-align: center;
      padding: 15px;
      border-radius: var(--border-radius);
      box-shadow: var(--inner-shadow);
      background-color: var(--neumorphic-bg);
      white-space: pre-line;
    }

    .word-box, .meaning-box {
      width: 100%;
      margin: 10px auto; /* ä¸Šä¸‹ã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚10pxã«æ¸›ã‚‰ã™ */
      padding: 20px;
      border-radius: var(--border-radius);
      background-color: var(--neumorphic-bg);
      box-shadow: var(--inner-shadow);
      text-align: center;
      min-height: 3em;
      display: flex;
      align-items: center;
      justify-content: center;
      word-break: break-word;
      box-sizing: border-box;
    }

    .word-box {
      font-family: Tahoma, sans-serif;
      font-size: 2.2em;
      font-weight: normal;
      color: var(--text-color);
      min-height: 80px;
    }
    .meaning-box {
      font-size: 1.6em;
      color: var(--text-color);
      min-height: 60px;
    }

    textarea {
      width: 100%;
      height: 120px;
      padding: 15px;
      border-radius: var(--border-radius);
      border: none;
      font-size: 1em;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin-top: 10px; /* ä¸Šã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚10pxã«æ¸›ã‚‰ã™ */
      background-color: var(--neumorphic-bg);
      box-shadow: var(--inner-shadow);
      resize: vertical;
      color: var(--text-color);
      box-sizing: border-box;
    }

    .button-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 10px; /* ä¸Šã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚10pxã«æ¸›ã‚‰ã™ */
    }

    /* åŸºæœ¬ã®ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      flex: 1 1 calc(50% - 15px);
      max-width: 170px;
      height: 45px;
      padding: 0;
      border: none;
      border-radius: var(--border-radius);
      font-size: 1.1em;
      font-weight: bold;
      cursor: pointer;
      background-color: var(--neumorphic-bg);
      box-shadow: var(--shadow-dark);
      color: var(--text-color);
      transition: all 0.2s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    button:hover {
      box-shadow: var(--inner-shadow);
      color: var(--main-color);
    }

    button:active {
      box-shadow: var(--inner-shadow);
      transform: scale(0.98);
    }

    /* ç‰¹å®šã®ãƒœã‚¿ãƒ³ã®è‰²ã¨å½± */
    button.primary {
      background-color: var(--main-color);
      color: white;
      box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2), -5px -5px 10px rgba(255, 255, 255, 0.7);
    }

    button.primary:hover {
      background-color: var(--accent-color);
      box-shadow: var(--inner-shadow);
      color: white;
    }

    button.secondary {
      background-color: var(--alt-color);
      color: white;
      box-shadow: 5px 5px 10px rgba(0, 0, 0, 0.2), -5px -5px 10px rgba(255, 255, 255, 0.7);
    }

    button.secondary:hover {
      background-color: var(--alt-accent);
      box-shadow: var(--inner-shadow);
      color: white;
    }

    /* å¹…ã„ã£ã±ã„ã®ãƒœã‚¿ãƒ³ */
    button.full-width {
      flex: 1 1 100%;
      max-width: 100%;
    }

    #result-box {
      width: 100%;
      max-width: 380px;
      margin-top: 5px; /* ä¸Šã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚5pxã«æ¸›ã‚‰ã™ */
      padding: 20px;
      background-color: var(--neumorphic-bg);
      border-radius: var(--border-radius);
      box-shadow: var(--inner-shadow);
      font-size: 0.95em;
      color: var(--text-color);
      text-align: left;
      box-sizing: border-box;
    }

    .result-row {
      margin-bottom: 8px;
      line-height: 1.6em;
    }

    .result-row.monospace {
      font-family: 'Consolas', 'Courier New', Courier, monospace;
      white-space: pre;
    }

    /* Small screens adjustments */
    @media (max-width: 420px) {
      body {
        padding: 0 15px; /* å°ç”»é¢ã§ã®å·¦å³ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚‚èª¿æ•´ã€ä¸Šã‚’0pxã« */
      }
      h1 {
        font-size: 1.8em;
      }
      .container {
        padding: 15px 15px; /* ä¸Šã®ä½™ç™½ã‚’ã•ã‚‰ã«ç‹­ãã™ã‚‹ãŸã‚15pxã«è¨­å®š */
      }
      .word-box {
        font-size: 1.8em;
      }
      .meaning-box {
        font-size: 1.3em;
      }
      button {
        flex: 1 1 calc(50% - 10px);
        font-size: 1em;
        height: 40px;
      }
      .button-container {
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>ãƒ‰ãƒªãƒ«å­¦ç¿’</h1>

  <div class="overall-progress-container">
    <div id="overall-progress-text">å…¨ä½“ã®é€²æ—: 0% (0/0å•)</div>
    <div class="overall-progress-bar">
      <div class="overall-progress-fill" id="overall-progress-fill"></div>
    </div>
  </div>

  <div class="progress-box" id="progress"></div>

  <div class="container" id="start-section">
    <p>Excelã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ãŸå˜èªï¼ˆå·¦åˆ—ï¼‰ãƒ»æ„å‘³ï¼ˆå³åˆ—ï¼‰ã‚’ä¸‹ã®æ å†…ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>æ³¨ï¼šæ å†…ã§ã¯ç›´æ¥ç·¨é›†ã—ãªã„ã§ãã ã•ã„ã€‚:</p>
    <textarea id="input-area" placeholder="ï¼œè²¼ã‚Šä»˜ã‘å¾Œã®è¡¨ç¤ºä¾‹ï¼&#10;apple,ã‚Šã‚“ã”&#10;cat,ã­ã“&#10;..."></textarea> 
    <div class="button-container">  
      <button class="primary full-width" onclick="startLearning()">å­¦ç¿’é–‹å§‹ (S)</button>
      <button class="secondary full-width" onclick="resetAllData()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ (D)</button>
    </div>
  </div>

  <div class="container" id="study-section" style="display:none;">
    <div class="word-box" id="word"></div>
    <div class="meaning-box" id="meaning"></div>
    <div class="button-container">
      <button class="primary" onclick="handleAnswer('Y')">æ­£è§£ (Y)</button>
      <button class="secondary" onclick="handleAnswer('N')">ä¸æ­£è§£ (N)</button>
      <button onclick="showAnswer()">ç­”ãˆ (A)</button>
      <button onclick="goBack()">ä¸€ã¤æˆ»ã‚‹ (â†)</button>
      <button id="speak-button">ğŸ”Š ç™ºéŸ³ (P)</button>
      <button onclick="returnToStart()">ä½œæˆç”»é¢ã¸ (C)</button>
      <button onclick="exportData()" class="full-width">ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ (E)</button>
    </div>
  </div>

  <div id="result-box" style="display:none;">
    <div id="result-rows"></div>
  </div>

  <script>
    let fullList = [], wordList = [], currentIndex = 0, wrongWords = [], currentRound = 1;
    let correctCount = 0, totalCount = 0;
    const roundStats = [];
    const STORAGE_KEY = 'wordLearningProgress';

    function saveProgress() {
      const data = { fullList, wordList, currentIndex, wrongWords, currentRound, correctCount, totalCount, roundStats };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadProgress() {
      const data = localStorage.getItem(STORAGE_KEY);
      if (data) {
        const parsed = JSON.parse(data);
        fullList = parsed.fullList;
        wordList = parsed.wordList;
        currentIndex = parsed.currentIndex;
        wrongWords = parsed.wrongWords;
        currentRound = parsed.currentRound;
        correctCount = parsed.correctCount || 0;
        totalCount = parsed.totalCount || 0;
        roundStats.push(...(parsed.roundStats || []));
        document.getElementById("start-section").style.display = "none";
        document.getElementById("study-section").style.display = "block";
        document.getElementById("result-box").style.display = "block";
        updateResultDisplay();
        updateOverallProgress(); // å…¨ä½“é€²æ—ãƒãƒ¼ã®æ›´æ–°
        showNext();
        return true;
      }
      return false;
    }

    function startLearning() {
      const input = document.getElementById("input-area").value.trim();
      fullList = input.split("\n").map(row => {
        const [word, meaning] = row.split(/\t|,/);
        return { word: word?.trim() || '', meaning: meaning?.trim() || '', cleared: 0 };
      }).filter(item => item.word);

      if (fullList.length === 0) {
        alert("å˜èªãƒ»æ„å‘³ã®ãƒšã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      wordList = [...fullList];
      currentIndex = 0;
      currentRound = 1;
      wrongWords = [];
      correctCount = 0;
      totalCount = 0;
      roundStats.length = 0;
      document.getElementById("result-box").style.display = "block";
      saveProgress();
      document.getElementById("start-section").style.display = "none";
      document.getElementById("study-section").style.display = "block";
      updateResultDisplay();
      updateOverallProgress(); // å…¨ä½“é€²æ—ãƒãƒ¼ã®æ›´æ–°
      showNext();
    }

    function showNext() {
      if (currentIndex >= wordList.length) {
        const correctInRound = wordList.length - wrongWords.length;
        roundStats.push({
          round: currentRound,
          total: wordList.length,
          correct: correctInRound,
          rate: Math.round((correctInRound / wordList.length) * 100)
        });
        if (wrongWords.length > 0 && currentRound < 5) {
          currentRound++;
          wordList = [...wrongWords];
          wrongWords = [];

            // â˜… 2å›ç›®ä»¥é™ã¯ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã¹æ›¿ãˆï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«ï¼‰
        if (currentRound >= 2) {
          for (let i = wordList.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [wordList[i], wordList[j]] = [wordList[j], wordList[i]];
          }
        }

          currentIndex = 0;
          alert(`ç¬¬${currentRound - 1}å›ãŒçµ‚äº†ã—ã¾ã—ãŸã€‚\né–“é•ã„ç›´ã—ã§${currentRound}å›ç›®ã‚’é–‹å§‹ã—ã¾ã™ã€‚`);
          updateResultDisplay();
          updateOverallProgress(); // å…¨ä½“é€²æ—ãƒãƒ¼ã®æ›´æ–°
          showNext();
        } else {
          alert("ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã™ã¹ã¦ã®å­¦ç¿’ãŒçµ‚äº†ã—ã¾ã—ãŸï¼");
          updateResultDisplay();
          saveProgress();
          //ä½œæˆç”»é¢ã¸ã¯ç§»å‹•ã›ãšã€ä»Šã®ã¾ã¾ã¨ã©ã¾ã‚‹ï¼ˆæ¬¡ã®2è¡Œã¯æˆ»ã£ã¦ã—ã¾ã†ã‚³ãƒ¼ãƒ‰ï¼‰
          //document.getElementById("study-section").style.display = "none";
          //document.getElementById("start-section").style.display = "block";
          updateOverallProgress(); // å…¨ä½“é€²æ—ãƒãƒ¼ã®æœ€çµ‚æ›´æ–°
        }
        return;
      }
      const entry = wordList[currentIndex];
      document.getElementById("word").textContent = entry.word;
      document.getElementById("meaning").textContent = "";
      document.getElementById("progress").textContent = `${currentIndex + 1} / ${wordList.length}ï¼ˆ${currentRound}å›ç›®ï¼‰`;
      saveProgress();
    }

    function handleAnswer(answer) {
      if (currentIndex >= wordList.length) return;

      const currentWord = wordList[currentIndex];
      if (answer === 'N') {
        wrongWords.push(currentWord);
      } else if (answer === 'Y') {
        const original = fullList.find(w => w.word === currentWord.word);
        if (original) original.cleared = currentRound;
      }
      currentIndex++;
      totalCount++;
      if(answer === 'Y') correctCount++;
      updateResultDisplay();
      updateOverallProgress(); // å…¨ä½“é€²æ—ãƒãƒ¼ã®æ›´æ–°
      showNext();
    }

    function updateResultDisplay() {
      const resultEl = document.getElementById("result-rows");
      if (roundStats.length === 0 && (totalCount === 0 || wordList.length === 0)) {
        resultEl.innerHTML = "<div style='text-align: center; color: #777;'>ã¾ã å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>";
        return;
      }

      resultEl.innerHTML = roundStats.map(stat => {
        const label = `ç¬¬${stat.round}å›ç›®`;
        const totalStr = String(stat.total).padStart(3, ' ');
        const correctStr = String(stat.correct).padStart(3, ' ');
        const rateStr = String(stat.rate).padStart(3, ' ') + '%';
        return `<div class='result-row monospace'>${label}ã€€${totalStr}å•ã€€${correctStr}å•æ­£è§£ã€€${rateStr}</div>`;
      }).join("");

      if (totalCount > 0 && currentIndex < wordList.length) {
        const currentProgressText = `<div class='result-row' style='font-weight: bold;'>ç¾åœ¨ã®æ­£ç­”ç‡: ${totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0}%</div>`;
        resultEl.innerHTML += currentProgressText;
      }
    }

    function updateOverallProgress() {
      const overallProgressTextEl = document.getElementById('overall-progress-text');
      const overallProgressFillEl = document.getElementById('overall-progress-fill');

      if (fullList.length === 0) {
        overallProgressTextEl.textContent = 'å…¨ä½“ã®é€²æ—: 0% (0/0å•)';
        overallProgressFillEl.style.width = '0%';
        return;
      }

      // clearedãŒ1ä»¥ä¸Šã®å˜èªæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const clearedCount = fullList.filter(item => item.cleared > 0).length;
      const totalWords = fullList.length;
      const progressPercentage = totalWords > 0 ? Math.round((clearedCount / totalWords) * 100) : 0;

      overallProgressTextEl.textContent = `å…¨ä½“ã®é€²æ—: ${progressPercentage}% (${clearedCount}/${totalWords}å•)`;
      overallProgressFillEl.style.width = `${progressPercentage}%`;
    }

    function showAnswer() {
      if (currentIndex >= wordList.length) return;
      document.getElementById("meaning").textContent = wordList[currentIndex]?.meaning || "";
    }

    function goBack() {
      if (currentIndex > 0) currentIndex--;
      document.getElementById("meaning").textContent = ""; // ç­”ãˆã‚’éš ã™
      showNext();
    }

    function returnToStart() {
      //å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¦ã—ã¾ã†ã®ã§ä¿®æ­£
     //if (confirm('ä½œæˆç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿç¾åœ¨ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚')) {
        //localStorage.removeItem(STORAGE_KEY);
        //location.reload();

         // ä¿å­˜ã•ã‚ŒãŸå­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã›ãšã«ä¿æŒ
      if (confirm('ä½œæˆç”»é¢ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) {
        document.getElementById("study-section").style.display = "none";
        document.getElementById("start-section").style.display = "block";
      }
    }

    function exportData() {
      if (fullList.length === 0) {
        alert("ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
        return;
      }
      const exportList = fullList.map(item => `${item.word}\t${item.meaning}\t${item.cleared}`).join("\n");
      const blob = new Blob(["\uFEFF" + exportList], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'drill_data.csv';
      document.body.appendChild(a); // For Firefox compatibility
      a.click();
      document.body.removeChild(a); // Clean up
      URL.revokeObjectURL(url);
    }

    function resetAllData() {
      if (confirm('ã™ã¹ã¦ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¾ã™ã‹ï¼Ÿ')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    document.getElementById("speak-button").addEventListener("click", () => {
      const word = document.getElementById("word").textContent.trim();
      if (!word) return;
      const utter = new SpeechSynthesisUtterance(word);
      utter.lang = "en-US";
      const voices = speechSynthesis.getVoices();
      const enVoice = voices.find(v => v.lang.startsWith("en") && (v.localService || v.name.includes("Google") || v.name.includes("Microsoft")));
      if (enVoice) utter.voice = enVoice;
      else console.warn("English voice not found, using default.");

      speechSynthesis.cancel();
      setTimeout(() => {
        speechSynthesis.speak(utter);
      }, 100);
    });

    document.addEventListener("keydown", (e) => {
      const key = e.key.toLowerCase();
      const inCreateScreen = document.getElementById("start-section").style.display !== "none";
      const inStudyScreen = document.getElementById("study-section").style.display !== "none";

      if (inCreateScreen) {
        if (key === "s") startLearning();
        else if (key === "d") resetAllData();
      } else if (inStudyScreen) {
        if (key === "y") handleAnswer('Y');
        else if (key === "n") handleAnswer('N');
        else if (key === "a") showAnswer();
        else if (key === "arrowleft") goBack();
        else if (key === "p") document.getElementById("speak-button").click();
        else if (key === "c") returnToStart();
        else if (key === "e") exportData();
      }
    });

    window.onload = function() {
      loadProgress();
      updateResultDisplay();
      updateOverallProgress(); // åˆæœŸãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚‚å…¨ä½“é€²æ—ãƒãƒ¼ã‚’æ›´æ–°
    }
  </script>
</body>
</html>